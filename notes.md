## Архитектура popug

### Сервисы

* `Auth` - отвечает за авторизацию пользователей, получение информации о пользователях другими сервисами.
* `TaskTracker` - отвечает за назначение/снятие задач, обладает доменом `Task`.
* `PaymentsService` - отвечет за баланс сотрудников + статистику по изменению этого баланса, обладает доменами `AccBalance`, `Payment`. В последнем хранится записи об изменении баланса.
* `PaymentsReportService` - отвечает за рассылку уведомлений о совершенных выплатах.
* `StatsDashBoard` - отвечает за репрезентацию статистики для менеджмента.

### Бизнес цепочки

**Назначение и завершение задачи**

Пользователь вызывает API для назначения или завершения задачи >>
Сервис `TaskTracker` делает запись в базу + генерирует событие о том, что произошло назначение задачи >>
Сервис `PaymentsService` делает запись в таблицу со статистикой по изменению баланса + изменяет баланс сотрудника 

> Какие проблемы могут возникнуть здесь:
Брокер может быть не доступен в момент, когда запись в БД уже сделана и тогда сообщение об изменении баланса будет утеряно,
что недопустимо. Решение - вызов API не влечет за собой синхронную запись в БД, а лишь генерирует событие, на которое подписан
и `TaskTracker`, и `PaymentsService`, обработав которые, они делают соответствующие записи в своих таблицах. 
Предыдущее решение также может породить проблемы с тем, что записи событий могут быть прочитаны несколько раз.
В случае с `TaskTracker` это не играет никакой роли, а вот в случае с `PaymentsService` могут возникать дубликаты событий в базе.
Решение - сделать обработку событий в payments service инвариантной, т.е. повторное чтение события не будет менять базу,
id записи `Payment` - хэш от его полей, где есть timestamp.

**Массовое переназначение задач**

Пользователь вызывает API для переназначения задач >>
Сервис `TaskTracker` по 1 берет задачу, запрашивает рандомного пользователя у `Auth` >> цепочка по назначению задач повторяется

> Какие проблемы могут возникнуть здесь:
Если количество пользователей и задач невелико, то можно сделать переназначение на все задачи сразу
Породив N событий в брокере, но тут могут возникнуть проблемы с синхронизацией, когда, процесс переназначения еще не завершился
а новый запрос на переназначение уже пришел - дубликаты событий на переназначение. В этом случае можно сделать отдельное событие
на переназначение задач, сервис будет обрабатывать их последовательно. Тогда возникает проблема с брокером, что если переназначение
Обработка этого события - запись батча событий на переназначение в топик из первого бизнес процесса.

**Ежедневные выплаты сотрудникам**

По расписанию каждый день база с балансами сотрудников скроллится, для каждого сотрудника обнуляется баланс +
делается выплата + генерируется событие о выплате, которое слушает `PaymentReportService`.

> Какие проблемы могут возникнуть здесь, аварийное завершение процесса выплат - не вся база проскроллена, в этом случае
в базе с балансами нужна метка, о том, что в конкретный день для сотрудника выплата была совершена, также нужна запись, к примеру в Redis,
о том, что на дату `M` все выплаты были произведены, процесс выплат будет ретраиться до тех пор, пока не будет проверена эта запись. 
Если некоторые события об оплатах пришли после выплат, хотя были сделаны в день, к которому относится выплата - то ничего страшного,
Выплата по этому событию будет произведена на следующий день, цель бизнес процесса - точное вознаграждение работников, строгими временными рамками
здесь можно пренебречь. Отсылка писем - не такой критичный процесс, и при ошибках в отправке письма, можно сделать
некоторое число ретраев перед коммитом, в случае неудачи - обрабатывать следующее событие. Некритично, если уведомление не придет сотруднику на почту.

**Просмотр статистики на дашборде**
Вся статистическая информация может быть получена аггрегациями из сервиса Payments



